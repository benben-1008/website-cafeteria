<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é£Ÿå ‚äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <header>
      <h1>ğŸ½ï¸ é£Ÿå ‚äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </h1>
      <p>ãŠåå‰ã¨ã”å¸Œæœ›ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    </header>

    <main>
      <section class="reservation-section">
        <div class="reservation-card">
          <h2>ğŸ“ äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </h2>

          <!-- äºˆç´„æ™‚é–“è¡¨ç¤º -->
          <div id="reservation-time-info"
            style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <h3 style="margin: 0 0 10px 0; color: #495057;">â° äºˆç´„å¯èƒ½æ™‚é–“</h3>
            <div id="time-display">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>

          <form id="reservation-form">
            <div class="form-group">
              <label for="student-name">ãŠåå‰ *</label>
              <input type="text" id="student-name" required placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ">
            </div>

            <div class="form-group">
              <label for="food">ã”å¸Œæœ›ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ *</label>
              <select id="food" required></select>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">äºˆç´„ã‚’ç¢ºå®š</button>
              <button type="button" onclick="resetForm()" class="btn btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </form>
        </div>
      </section>

      <section class="menu-table-section">
        <div class="reservation-card">
          <h2>ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§</h2>
          <table class="menu-table" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 8px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th>
                <th style="text-align: right; border-bottom: 1px solid #ddd; padding: 8px;">å€¤æ®µï¼ˆå††ï¼‰</th>
                <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 8px;">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">æ—¥æ›¿ã‚ã‚Šå®šé£Ÿ</td>
                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f0f0f0;">550</td>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">æœªå®š</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">æ—¥æ›¿ã‚ã‚Šä¸¼</td>
                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f0f0f0;">450</td>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">æœªå®š</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹</td>
                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f0f0f0;">450</td>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">ç±³</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">ã‚«ãƒ„ã‚«ãƒ¬ãƒ¼</td>
                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f0f0f0;">500</td>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">ç±³</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">é†¤æ²¹ãƒ©ãƒ¼ãƒ¡ãƒ³</td>
                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f0f0f0;">450</td>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">å°éº¦</td>
              </tr>
              <tr>
                <td style="padding: 8px;">ã‹ã‘ã†ã©ã‚“</td>
                <td style="padding: 8px; text-align: right;">350</td>
                <td style="padding: 8px;">å°éº¦</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <section class="info-section">
      <h2>ğŸ”— URLãƒªãƒ³ã‚¯</h2>
      <div id="page-links" class="info-card"></div>
    </section>

    <footer>
      <a href="index.html" class="back-link">â† ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
    </footer>
  </div>

  <script>
    const API_BASE = 'api/';
    async function apiGet(path) {
      const res = await fetch(API_BASE + path, { cache: 'no-store' });
      if (!res.ok) throw new Error('GET failed: ' + path);
      return await res.json();
    }
    async function apiPost(path, data) {
      const res = await fetch(API_BASE + path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error('POST failed: ' + path);
      return await res.json();
    }
    async function loadMenuOptions() {
      const select = document.getElementById("food");
      const menus = await apiGet('menu.php');
      select.innerHTML = "";

      if (menus.length === 0) {
        select.innerHTML = "<option>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</option>";
        select.disabled = true;
        return;
      }

      menus.forEach(menu => {
        const option = document.createElement("option");
        option.value = menu.name;

        if (menu.stock === -1) {
          // ç„¡åˆ¶é™ãƒ¡ãƒ‹ãƒ¥ãƒ¼
          option.textContent = `${menu.name}ï¼ˆç„¡åˆ¶é™ï¼‰`;
          option.disabled = false;
        } else if (menu.stock > 0) {
          // é€šå¸¸ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆåœ¨åº«ã‚ã‚Šï¼‰
          option.textContent = `${menu.name}ï¼ˆæ®‹ã‚Š${menu.stock}é£Ÿï¼‰`;
          option.disabled = false;
        } else {
          // å£²ã‚Šåˆ‡ã‚Œ
          option.textContent = `${menu.name}ï¼ˆå£²ã‚Šåˆ‡ã‚Œï¼‰`;
          option.disabled = true;
        }

        select.appendChild(option);
      });
    }

    // äºˆç´„æ™‚é–“ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
    async function checkReservationTime() {
      try {
        const times = await apiGet('reservation-times.php');
        const timeDisplay = document.getElementById('time-display');

        if (!times || !times.enabled) {
          timeDisplay.innerHTML = '<p style="color: #28a745;">âœ… äºˆç´„æ™‚é–“åˆ¶é™ãªã—ï¼ˆã„ã¤ã§ã‚‚äºˆç´„å¯èƒ½ï¼‰</p>';
          return true;
        }

        const now = new Date();
        const currentTime = now.toTimeString().slice(0, 5); // HH:MMå½¢å¼
        const startTime = times.startTime;
        const endTime = times.endTime;

        const isWithinTime = currentTime >= startTime && currentTime <= endTime;

        if (isWithinTime) {
          timeDisplay.innerHTML = `
            <p style="color: #28a745;">âœ… ç¾åœ¨äºˆç´„å¯èƒ½ã§ã™</p>
            <p style="font-size: 14px; color: #6c757d;">äºˆç´„æ™‚é–“: ${startTime} - ${endTime}</p>
            <p style="font-size: 14px; color: #6c757d;">ç¾åœ¨æ™‚åˆ»: ${currentTime}</p>
          `;
        } else {
          timeDisplay.innerHTML = `
            <p style="color: #dc3545;">âŒ ç¾åœ¨ã¯äºˆç´„æ™‚é–“å¤–ã§ã™</p>
            <p style="font-size: 14px; color: #6c757d;">äºˆç´„æ™‚é–“: ${startTime} - ${endTime}</p>
            <p style="font-size: 14px; color: #6c757d;">ç¾åœ¨æ™‚åˆ»: ${currentTime}</p>
            <p style="font-size: 14px; color: #6c757d;">${times.message}</p>
          `;
        }

        return isWithinTime;
      } catch (error) {
        console.error('äºˆç´„æ™‚é–“ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('time-display').innerHTML = '<p style="color: #dc3545;">âŒ äºˆç´„æ™‚é–“ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
        return false;
      }
    }

    document.getElementById("reservation-form").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("student-name").value.trim();
      const food = document.getElementById("food").value;
      if (!name || !food) return alert("å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      // äºˆç´„æ™‚é–“ãƒã‚§ãƒƒã‚¯
      const isWithinTime = await checkReservationTime();
      if (!isWithinTime) {
        alert("ç¾åœ¨ã¯äºˆç´„æ™‚é–“å¤–ã§ã™ã€‚äºˆç´„å¯èƒ½æ™‚é–“å†…ã«å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        return;
      }

      const menus = await apiGet('menu.php');
      const menu = menus.find(m => m.name === food);
      if (!menu || (menu.stock !== -1 && menu.stock <= 0)) {
        alert("ã“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯å£²ã‚Šåˆ‡ã‚Œã§ã™ã€‚");
        return;
      }

      // äºˆç´„ç™»éŒ²
      const reservations = await apiGet('reservations.php');
      reservations.push({ name, food, createdAt: new Date().toISOString() });
      await apiPost('reservations.php', reservations);

      // åœ¨åº«ã‚’æ¸›ã‚‰ã™ï¼ˆç„¡åˆ¶é™ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯é™¤ãï¼‰
      if (menu.stock !== -1) {
        menu.stock -= 1;
        await apiPost('menu.php', menus);
      }

      alert("äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
      document.getElementById("reservation-form").reset();
      loadMenuOptions();
    });

    function resetForm() {
      document.getElementById("reservation-form").reset();
    }

    function renderLinks() {
      const base = window.location.href.replace(/[^/]*$/, '');
      const pages = [
        { name: 'ç”Ÿå¾’ç”¨ã‚µã‚¤ãƒˆ (index.html)', file: 'index.html' },
        { name: 'äºˆç´„ã‚µã‚¤ãƒˆ (reservation.html)', file: 'reservation.html' },
        { name: 'é£Ÿå ‚å°‚ç”¨AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ (ai-assistant-php.html)', file: 'ai-assistant-php.html' }
      ];
      const linksDiv = document.getElementById('page-links');
      if (!linksDiv) return;
      linksDiv.innerHTML = pages.map(p => {
        const url = base + p.file;
        return `<p><strong>${p.name}:</strong> <a href="${url}">${url}</a></p>`;
      }).join('');
    }

    window.onload = function () {
      loadMenuOptions();
      checkReservationTime();
      renderLinks();

      // 1åˆ†ã”ã¨ã«äºˆç´„æ™‚é–“ã‚’ãƒã‚§ãƒƒã‚¯
      setInterval(checkReservationTime, 60000);
    };
  </script>
</body>

</html>